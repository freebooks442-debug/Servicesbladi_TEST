{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Détails Utilisateur - Administration{% endblock %}
{% block page_title %}Détails de l'utilisateur{% endblock %}

{% block extra_css %}
<!-- No additional CSS needed for the new dashboard layout -->
{% endblock %}

{% block content %}
<div class="space-y-6">
  
  <!-- Back button and header -->
  <div class="bg-white shadow-lg rounded-2xl border border-gray-100 p-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
      <div class="flex items-center space-x-4">
        <a href="{% url 'admin_users' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
          <i class="bi bi-arrow-left mr-2"></i> Retour aux utilisateurs
        </a>
        <h2 class="text-lg font-semibold text-gray-900">{{ target_user.first_name }} {{ target_user.name }}</h2>
      </div>
      <div class="flex flex-wrap gap-2">
        <a href="{% url 'admin_edit_user' user_id=target_user.id %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
          <i class="bi bi-pencil mr-2"></i>Modifier
        </a>
        {% if target_user.is_active %}
        <button type="button" class="inline-flex items-center px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors" onclick="confirmToggleStatus({{ target_user.id }}, false)">
          <i class="bi bi-x-circle mr-2"></i>Désactiver
        </button>
        {% else %}
        <button type="button" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors" onclick="confirmToggleStatus({{ target_user.id }}, true)">
          <i class="bi bi-check-circle mr-2"></i>Activer
        </button>
        {% endif %}
        <button type="button" class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors" onclick="confirmDelete({{ target_user.id }})">
          <i class="bi bi-trash mr-2"></i>Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- User Profile Card -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
      <div class="bg-white shadow-lg rounded-2xl border border-gray-100 h-full">
        <div class="px-6 py-4 border-b border-gray-200">
          <h6 class="text-lg font-semibold text-gray-900">Informations de base</h6>
        </div>
        <div class="p-6">
          <div class="text-center mb-6">
            <img class="w-32 h-32 rounded-full mx-auto mb-4 object-cover" 
            src="{{ target_user.get_profile_picture_url }}" alt="Profile">
            <h5 class="text-xl font-semibold text-gray-900 mb-2">{{ target_user.first_name }} {{ target_user.name }}</h5>
            {% if target_user.account_type == 'CLIENT' or target_user.account_type == 'client' %}
            <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Client</span>
            {% elif target_user.account_type == 'EXPERT' or target_user.account_type == 'expert' %}
            <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Expert</span>
            {% elif target_user.account_type == 'ADMIN' or target_user.account_type == 'admin' %}
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Admin</span>
            {% endif %}
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full {% if target_user.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} mt-2">
              {% if target_user.is_active %}Actif{% else %}Inactif{% endif %}
            </span>
          </div>

          <div class="space-y-4">
            <div>
              <h6 class="text-sm font-medium text-gray-700 mb-1">Email:</h6>
              <p class="text-gray-900">{{ target_user.email }}</p>
            </div>

            <div>
              <h6 class="text-sm font-medium text-gray-700 mb-1">Téléphone:</h6>
              <p class="text-gray-900">{{ target_user.phone|default:"Non renseigné" }}</p>
            </div>

            <div>
              <h6 class="text-sm font-medium text-gray-700 mb-1">Date d'inscription:</h6>
              <p class="text-gray-900">{{ target_user.date_joined|date:"d/m/Y H:i" }}</p>
            </div>

            <div>
              <h6 class="text-sm font-medium text-gray-700 mb-1">Dernière connexion:</h6>
              <p class="text-gray-900">{{ target_user.last_login|date:"d/m/Y H:i"|default:"Jamais" }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>    <!-- User Profile Information -->
    <div class="lg:col-span-2">
      <div class="bg-white shadow-lg rounded-2xl border border-gray-100 h-full">
        <div class="px-6 py-4 border-b border-gray-200">
          <h6 class="text-lg font-semibold text-gray-900">Informations supplémentaires</h6>
        </div>
        <div class="p-6">
          {% if target_user.account_type == 'CLIENT' or target_user.account_type == 'client' %}
            <!-- Client specific information -->
            {% if client_profile %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h6 class="text-sm font-medium text-gray-700 mb-1">Statut MRE:</h6>
                <p class="text-gray-900">{% if client_profile.mre_status %}Oui{% else %}Non{% endif %}</p>
              </div>
              <div>
                <h6 class="text-sm font-medium text-gray-700 mb-1">Pays d'origine:</h6>
                <p class="text-gray-900">{{ client_profile.origin_country|default:"Non renseigné" }}</p>
              </div>
              <div class="6 mb-3">
                <h6 class="text-primary">Dernière visite au Maroc:</h6>
                <p>{{ client_profile.last_visit|date:"d/m/Y"|default:"Non renseigné" }}</p>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning">Profil client non trouvé</div>
            {% endif %}
          {% elif target_user.account_type == 'EXPERT' or target_user.account_type == 'expert' %}
            <!-- Expert specific information -->
            {% if expert_profile %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="6 mb-3">
                <h6 class="text-primary">Spécialité:</h6>
                <p>{{ expert_profile.specialty|default:"Non renseigné" }}</p>
              </div>
              <div class="6 mb-3">
                <h6 class="text-primary">Langues parlées:</h6>
                <p>{{ expert_profile.spoken_languages|default:"Non renseigné" }}</p>
              </div>
              <div class="6 mb-3">
                <h6 class="text-primary">Années d'expérience:</h6>
                <p>{{ expert_profile.years_of_experience|default:"0" }}</p>
              </div>
              <div class="6 mb-3">
                <h6 class="text-primary">Tarif horaire:</h6>
                <p>{{ expert_profile.hourly_rate|default:"0" }} Dh/h</p>
              </div>
              <div class="col-12 mb-3">
                <h6 class="text-primary">Biographie:</h6>
                <p>{{ expert_profile.biography|default:"Non renseigné" }}</p>
              </div>
              <div class="col-12 mb-3">
                <h6 class="text-primary">Compétences:</h6>
                <p>{{ expert_profile.competencies|default:"Non renseigné" }}</p>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning">Profil expert non trouvé</div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>  <!-- Activity Dashboard -->
  <div class="bg-white shadow-lg rounded-2xl border border-gray-100 p-6">
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 mb-2">Aperçu de l'activité</h3>
      <p class="text-gray-600">Résumé des activités et données importantes de l'utilisateur</p>
    </div>

    <!-- Activity Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Requests Card -->
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-600 text-sm font-medium">Demandes</p>
            <p class="text-2xl font-bold text-blue-900">{{ service_requests.count }}</p>
          </div>
          <div class="bg-blue-500 rounded-lg p-3">
            <i class="bi bi-file-earmark-text text-white text-xl"></i>
          </div>
        </div>
        {% if service_requests.count > 0 %}
        <div class="mt-4">
          <a href="#requests-section" class="text-blue-600 text-sm font-medium hover:text-blue-800 inline-flex items-center" onclick="scrollToSection('requests-section')">
            Voir les détails <i class="bi bi-arrow-right ml-1"></i>
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Documents Card -->
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-600 text-sm font-medium">Documents</p>
            <p class="text-2xl font-bold text-green-900">{{ documents.count }}</p>
          </div>
          <div class="bg-green-500 rounded-lg p-3">
            <i class="bi bi-file-earmark text-white text-xl"></i>
          </div>
        </div>
        {% if documents.count > 0 %}
        <div class="mt-4">
          <a href="#documents-section" class="text-green-600 text-sm font-medium hover:text-green-800 inline-flex items-center" onclick="scrollToSection('documents-section')">
            Voir les détails <i class="bi bi-arrow-right ml-1"></i>
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Messages Card -->
      <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-600 text-sm font-medium">Messages</p>
            <p class="text-2xl font-bold text-purple-900">{{ messages_list.count }}</p>
          </div>
          <div class="bg-purple-500 rounded-lg p-3">
            <i class="bi bi-chat-dots text-white text-xl"></i>
          </div>
        </div>
        {% if messages_list.count > 0 %}
        <div class="mt-4">
          <a href="#messages-section" class="text-purple-600 text-sm font-medium hover:text-purple-800 inline-flex items-center" onclick="scrollToSection('messages-section')">
            Voir les détails <i class="bi bi-arrow-right ml-1"></i>
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Appointments Card -->
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-600 text-sm font-medium">Rendez-vous</p>
            <p class="text-2xl font-bold text-orange-900">{{ appointments.count }}</p>
          </div>
          <div class="bg-orange-500 rounded-lg p-3">
            <i class="bi bi-calendar-event text-white text-xl"></i>
          </div>
        </div>
        {% if appointments.count > 0 %}
        <div class="mt-4">
          <a href="#appointments-section" class="text-orange-600 text-sm font-medium hover:text-orange-800 inline-flex items-center" onclick="scrollToSection('appointments-section')">
            Voir les détails <i class="bi bi-arrow-right ml-1"></i>
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Activity Summary -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Recent Requests -->
      <div class="bg-gray-50 rounded-xl p-6">
        <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
          <i class="bi bi-clock-history text-blue-500 mr-2"></i>
          Demandes récentes
        </h4>
        {% if service_requests %}
          {% for request in service_requests|slice:":3" %}
          <div class="flex items-center justify-between py-3 {% if not forloop.last %}border-b border-gray-200{% endif %}">
            <div>
              <p class="font-medium text-gray-900">#{{ request.id }} - {{ request.service.title|truncatechars:30 }}</p>
              <p class="text-sm text-gray-500">{{ request.created_at|date:"d/m/Y" }}</p>
            </div>
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
              {% if request.status == 'new' %}bg-blue-100 text-blue-800
              {% elif request.status == 'pending_info' %}bg-yellow-100 text-yellow-800
              {% elif request.status == 'in_progress' %}bg-purple-100 text-purple-800
              {% elif request.status == 'completed' %}bg-green-100 text-green-800
              {% elif request.status == 'cancelled' %}bg-red-100 text-red-800
              {% else %}bg-gray-100 text-gray-800{% endif %}">
              {% if request.status == 'new' %}Nouveau
              {% elif request.status == 'pending_info' %}En attente
              {% elif request.status == 'in_progress' %}En cours
              {% elif request.status == 'completed' %}Terminé
              {% elif request.status == 'cancelled' %}Annulé
              {% else %}{{ request.get_status_display }}{% endif %}
            </span>
          </div>
          {% endfor %}
        {% else %}
        <p class="text-gray-500 text-center py-8">Aucune demande récente</p>
        {% endif %}
      </div>

      <!-- Recent Messages -->
      <div class="bg-gray-50 rounded-xl p-6">
        <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
          <i class="bi bi-chat-dots text-purple-500 mr-2"></i>
          Messages récents
        </h4>
        {% if messages_list %}
          {% for msg in messages_list|slice:":3" %}
          <div class="flex items-start justify-between py-3 {% if not forloop.last %}border-b border-gray-200{% endif %}">
            <div class="flex-1">
              <p class="text-sm text-gray-900">
                {% if msg.sender.id == target_user.id %}
                  <span class="text-green-600 font-medium">À: {{ msg.recipient.name }}</span>
                {% else %}
                  <span class="text-blue-600 font-medium">De: {{ msg.sender.name }}</span>
                {% endif %}
              </p>
              <p class="text-xs text-gray-600 mt-1">{{ msg.content|truncatechars:40 }}</p>
              <p class="text-xs text-gray-400 mt-1">{{ msg.sent_at|date:"d/m H:i" }}</p>
            </div>
            {% if not msg.is_read %}
            <span class="inline-flex w-2 h-2 bg-red-400 rounded-full"></span>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
        <p class="text-gray-500 text-center py-8">Aucun message récent</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Detailed Sections -->
  <!-- Requests Section -->
  {% if service_requests %}
  <div id="requests-section" class="bg-white shadow-lg rounded-2xl border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center">
        <i class="bi bi-file-earmark-text text-blue-500 mr-2"></i>
        Toutes les demandes ({{ service_requests.count }})
      </h3>
    </div>
    <div class="p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for request in service_requests %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#{{ request.id }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ request.service.title }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                  {% if request.status == 'new' %}bg-blue-100 text-blue-800
                  {% elif request.status == 'pending_info' %}bg-yellow-100 text-yellow-800
                  {% elif request.status == 'in_progress' %}bg-purple-100 text-purple-800
                  {% elif request.status == 'completed' %}bg-green-100 text-green-800
                  {% elif request.status == 'cancelled' %}bg-red-100 text-red-800
                  {% else %}bg-gray-100 text-gray-800{% endif %}">
                  {% if request.status == 'new' %}Nouveau
                  {% elif request.status == 'pending_info' %}En attente d'info
                  {% elif request.status == 'in_progress' %}En cours
                  {% elif request.status == 'completed' %}Terminé
                  {% elif request.status == 'cancelled' %}Annulé
                  {% elif request.status == 'rejected' %}Rejeté
                  {% else %}{{ request.get_status_display }}{% endif %}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ request.created_at|date:"d/m/Y" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="{% url 'admin_request_detail' request_id=request.id %}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  <i class="bi bi-eye mr-1"></i>
                  Voir
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Documents Section -->
  {% if documents %}
  <div id="documents-section" class="bg-white shadow-lg rounded-2xl border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center">
        <i class="bi bi-file-earmark text-green-500 mr-2"></i>
        Tous les documents ({{ documents.count }})
      </h3>
    </div>
    <div class="p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for doc in documents %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ doc.name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ doc.get_type_display }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ doc.upload_date|date:"d/m/Y" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="{{ doc.file.url }}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" target="_blank">
                  <i class="bi bi-eye mr-1"></i>
                  Voir
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Messages Section -->
  {% if messages_list %}
  <div id="messages-section" class="bg-white shadow-lg rounded-2xl border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center">
        <i class="bi bi-chat-dots text-purple-500 mr-2"></i>
        Tous les messages ({{ messages_list.count }})
      </h3>
    </div>
    <div class="p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avec</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contenu</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for msg in messages_list %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if msg.sender.id == target_user.id %}
                <span class="text-green-600 font-medium">À: {{ msg.recipient.name }} {{ msg.recipient.first_name }}</span>
                {% else %}
                <span class="text-blue-600 font-medium">De: {{ msg.sender.name }} {{ msg.sender.first_name }}</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">{{ msg.content|truncatechars:50 }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ msg.sent_at|date:"d/m/Y H:i" }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if msg.is_read %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Lu</span>
                {% else %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Non lu</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Appointments Section -->
  {% if appointments %}
  <div id="appointments-section" class="bg-white shadow-lg rounded-2xl border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center">
        <i class="bi bi-calendar-event text-orange-500 mr-2"></i>
        Tous les rendez-vous ({{ appointments.count }})
      </h3>
    </div>
    <div class="p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avec</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for appointment in appointments %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if appointment.client.id == target_user.id %}
                <span class="font-medium">Expert: {{ appointment.expert.name }} {{ appointment.expert.first_name }}</span>
                {% else %}
                <span class="font-medium">Client: {{ appointment.client.name }} {{ appointment.client.first_name }}</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ appointment.date_time|date:"d/m/Y H:i" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ appointment.get_consultation_type_display }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if appointment.status == 'scheduled' %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Planifié</span>
                {% elif appointment.status == 'confirmed' %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Confirmé</span>
                {% elif appointment.status == 'cancelled' %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Annulé</span>
                {% elif appointment.status == 'completed' %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Terminé</span>
                {% elif appointment.status == 'missed' %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Manqué</span>
                {% else %}
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">{{ appointment.get_status_display }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Add CSRF token for AJAX requests -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

{% endblock %}

{% block scripts %}
<script>
  // Wait for DOM to be fully loaded before defining functions
  document.addEventListener('DOMContentLoaded', function() {
    // Define functions in global scope to ensure they're available for onclick handlers
    window.confirmToggleStatus = function(userId, makeActive) {
      console.log('confirmToggleStatus called with:', userId, makeActive);
      const action = makeActive ? 'activer' : 'désactiver';
      if (confirm(`Êtes-vous sûr de vouloir ${action} cet utilisateur ?`)) {
        console.log('User confirmed action, making request...');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        console.log('CSRF token element:', csrfToken);
        
        if (!csrfToken) {
          alert('Erreur: Token CSRF non trouvé');
          return;
        }
        
        // Use AJAX for better user experience
        fetch(`/admin/users/${userId}/toggle-status/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ active: makeActive })
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            location.reload(); // Reload to show updated status
          } else {
            alert('Erreur lors de la modification du statut: ' + (data.message || 'Erreur inconnue'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Erreur lors de la modification du statut: ' + error.message);
        });
      }
    };

    // Define delete function in global scope
    window.confirmDelete = function(userId) {
      console.log('confirmDelete called with:', userId);
      if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ? Cette action est irréversible.')) {
        console.log('User confirmed deletion, making request...');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        console.log('CSRF token element:', csrfToken);
        
        if (!csrfToken) {
          alert('Erreur: Token CSRF non trouvé');
          return;
        }
        
        // Use AJAX for better user experience
        fetch(`/admin/users/${userId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            alert('Utilisateur supprimé avec succès');
            window.location.href = '/admin/users/'; // Redirect to users list
          } else {
            alert('Erreur lors de la suppression: ' + (data.message || 'Erreur inconnue'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Erreur lors de la suppression: ' + error.message);
        });
      }
    };

    // Smooth scroll to section function
    window.scrollToSection = function(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        element.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
    };

    // Test that functions are loaded
    console.log('Admin user detail functions loaded:', {
      confirmToggleStatus: typeof window.confirmToggleStatus,
      confirmDelete: typeof window.confirmDelete,
      scrollToSection: typeof window.scrollToSection
    });
  });
</script>
{% endblock %}