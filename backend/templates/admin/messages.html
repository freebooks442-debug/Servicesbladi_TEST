{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Gestion des Messages - Administration{% endblock %}
{% block page_title %}Gestion des Messages{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- Alert Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border border-green-400 text-green-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Error Display -->
  {% if error %}
    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
      <p>Une erreur est survenue: {{ error }}</p>
    </div>
  {% endif %}
  
  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white overflow-hidden shadow-lg rounded-2xl border border-gray-100">
      <div class="p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
              <i class="bi bi-envelope-fill text-blue-600 text-xl"></i>
            </div>
          </div>
          <div class="ml-4 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Total des Messages</dt>
              <dd class="text-2xl font-bold text-gray-900">{{ stats.total|default:0 }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow-lg rounded-2xl border border-gray-100">
      <div class="p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <i class="bi bi-envelope-check text-green-600 text-xl"></i>
            </div>
          </div>
          <div class="ml-4 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">Messages Lus</dt>
              <dd class="text-2xl font-bold text-gray-900">{{ stats.read|default:0 }}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
      <div class="flex items-center">
        <div class="flex-1">
          <div class="text-xs font-bold text-yellow-600 uppercase mb-1">Messages Non Lus</div>
          <div class="text-2xl font-bold text-gray-800">{{ stats.unread }}</div>
        </div>
        <div class="text-gray-400">
          <i class="bi bi-envelope-exclamation text-3xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-cyan-500">
      <div class="flex items-center">
        <div class="flex-1">          <div class="text-xs font-bold text-cyan-600 uppercase mb-1">Nouveaux (24h)</div>
          <div class="text-2xl font-bold text-gray-800">{{ stats.recent }}</div>
        </div>
        <div class="text-gray-400">
          <i class="bi bi-clock-history text-3xl"></i>
        </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Message Filters -->
  <div class="bg-white rounded-lg shadow-md mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h6 class="text-lg font-semibold text-gray-800">Filtres</h6>
    </div>
    <div class="p-6">
      <form method="get" action="{% url 'admin_messages' %}">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="status" name="status">
              <option value="" {% if not status_filter %}selected{% endif %}>Tous les statuts</option>
              <option value="read" {% if status_filter == 'read' %}selected{% endif %}>Lus</option>
              <option value="unread" {% if status_filter == 'unread' %}selected{% endif %}>Non lus</option>
            </select>
          </div>
          <div>
            <label for="period" class="block text-sm font-medium text-gray-700 mb-2">Période</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="period" name="period">
              <option value="" {% if not period_filter %}selected{% endif %}>Toutes les périodes</option>
              <option value="today" {% if period_filter == 'today' %}selected{% endif %}>Aujourd'hui</option>
              <option value="week" {% if period_filter == 'week' %}selected{% endif %}>Cette semaine</option>
              <option value="month" {% if period_filter == 'month' %}selected{% endif %}>Ce mois</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Recherche</label>
            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="search" name="search" value="{{ search_query }}" placeholder="Rechercher...">
          </div>
          <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Filtrer</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- Messages List -->
  <div class="bg-white rounded-lg shadow-md">
    <div class="px-6 py-4 border-b border-gray-200">
      <h6 class="text-lg font-semibold text-gray-800">Messages</h6>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expéditeur</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destinataire</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contenu</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Demande</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% if messages_list %}
            {% for msg in messages_list %}
            <tr class="{% if not msg.is_read %}bg-yellow-50{% endif %} hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ msg.sent_at|date:"d/m/Y H:i" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ msg.sender.first_name }} {{ msg.sender.name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ msg.recipient.first_name }} {{ msg.recipient.name }}</td>
              <td class="px-6 py-4 text-sm text-gray-900">{{ msg.content|truncatechars:50 }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if msg.service_request %}
                  <a href="#" class="text-blue-600 hover:text-blue-800">{{ msg.service_request.service.title|truncatechars:20 }}</a>
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if msg.is_read %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Lu</span>                {% else %}
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Non lu</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <button type="button" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors view-message" data-message-id="{{ msg.id }}" data-message-content="{{ msg.content }}" data-sender="{{ msg.sender.first_name }} {{ msg.sender.name }}" data-receiver="{{ msg.recipient.first_name }} {{ msg.recipient.name }}" data-date="{{ msg.sent_at|date:'d/m/Y H:i' }}" onclick="openMessageModal(this)">
                  <i class="bi bi-eye"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucun message trouvé.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Message View Modal -->
<div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen px-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h5 class="text-lg font-semibold text-gray-800">Détails du Message</h5>
        <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeMessageModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <strong class="text-gray-700">Date:</strong> <span id="message-date" class="ml-2"></span>
        </div>
        <div class="mb-4">
          <strong class="text-gray-700">De:</strong> <span id="message-sender" class="ml-2"></span>
        </div>
        <div class="mb-4">
          <strong class="text-gray-700">À:</strong> <span id="message-receiver" class="ml-2"></span>
        </div>
        <div class="mb-4">
          <strong class="text-gray-700">Message:</strong>
          <div class="mt-2 p-4 bg-gray-50 rounded-lg" id="message-content"></div>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
        <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors" onclick="closeMessageModal()">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
function openMessageModal(button) {
  const content = button.getAttribute('data-message-content');
  const sender = button.getAttribute('data-sender');
  const receiver = button.getAttribute('data-receiver');
  const date = button.getAttribute('data-date');
  
  document.getElementById('message-content').textContent = content;
  document.getElementById('message-sender').textContent = sender;
  document.getElementById('message-receiver').textContent = receiver;
  document.getElementById('message-date').textContent = date;
  
  // Show modal
  document.getElementById('messageModal').classList.remove('hidden');
  
  // Mark the message as read via AJAX
  const messageId = button.getAttribute('data-message-id');
  markAsRead(messageId);
}

function closeMessageModal() {
  document.getElementById('messageModal').classList.add('hidden');
}

// Function to mark message as read
function markAsRead(messageId) {
  fetch(`/admin/messages/${messageId}/mark-read/`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update UI to show message is now read
      const messageRow = document.querySelector(`button[data-message-id="${messageId}"]`).closest('tr');
      messageRow.classList.remove('bg-yellow-50');
      const statusBadge = messageRow.querySelector('.bg-yellow-100');
      if (statusBadge) {
        statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800');
        statusBadge.classList.add('bg-green-100', 'text-green-800');
        statusBadge.textContent = 'Lu';
      }
    }
  })
  .catch(error => console.error('Error:', error));
}

// Function to get CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
