{% extends 'expert/base.html' %}
{% load static %}

{% block title %}Demande #{{ service_request.id }} - Expert{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="mb-6">
      <ol class="flex items-center space-x-2 text-sm">
        <li><a href="{% url 'expert_dashboard' %}" class="text-blue-600 hover:text-blue-800">Tableau de bord</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="{% url 'expert_demandes' %}" class="text-blue-600 hover:text-blue-800">Demandes</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">Demande #{{ service_request.id }}</li>
      </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Request Information Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">Informations de la demande</h2>
            {% if service_request.status == 'new' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ service_request.get_status_display }}
              </span>
            {% elif service_request.status == 'in_progress' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                {{ service_request.get_status_display }}
              </span>
            {% elif service_request.status == 'completed' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                {{ service_request.get_status_display }}
              </span>
            {% elif service_request.status == 'cancelled' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                {{ service_request.get_status_display }}
              </span>
            {% elif service_request.status == 'pending_info' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                {{ service_request.get_status_display }}
              </span>
            {% endif %}
          </div>
          <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Titre:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.title }}</dd>
              </div>
              <div class="md:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Service:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.service.title }}</dd>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Type de service:</dt>
                <dd class="text-sm text-gray-900">{% if service_type %}{{ service_type.name }}{% else %}Non spécifié{% endif %}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Client:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.client.first_name }} {{ service_request.client.name }}</dd>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Téléphone du client:</dt>
                <dd class="text-sm text-gray-900">{{ client.phone }}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Date souhaitée:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.desired_date|date:"d/m/Y" }}</dd>
              </div>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Description:</dt>
              <dd class="mt-2 text-sm text-gray-900 bg-gray-50 p-3 rounded-md">{{ service_request.description }}</dd>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Date de création:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.created_at|date:"d/m/Y H:i" }}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Dernière mise à jour:</dt>
                <dd class="text-sm text-gray-900">{{ service_request.updated_at|date:"d/m/Y H:i" }}</dd>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Priorité:</dt>
                <dd class="text-sm">
                  {% if service_request.priority == 'high' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      {{ service_request.get_priority_display }}
                    </span>
                  {% elif service_request.priority == 'medium' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      {{ service_request.get_priority_display }}
                    </span>
                  {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      {{ service_request.get_priority_display }}
                    </span>
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Urgence:</dt>
                <dd class="text-sm">
                  {% if service_request.is_urgent %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                      Urgent
                    </span>
                  {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Normal
                    </span>
                  {% endif %}
                </dd>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">Documents</h2>
            <div class="flex space-x-2">
              <a href="{% url 'custom_requests:expert_documents' %}" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Voir tous les documents
              </a>
              <button type="button" onclick="openModal('uploadDocumentModal')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Ajouter un document
              </button>
            </div>
          </div>
          <div class="p-6">
            {% if documents %}
              <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                <table class="min-w-full divide-y divide-gray-300">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléchargé par</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    {% for doc in documents %}
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ doc.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.uploaded_by.first_name }} {{ doc.uploaded_by.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.created_at|date:"d/m/Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                          <a href="{% url 'custom_requests:view_document' doc.id %}" target="_blank" class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-blue-600 bg-blue-100 hover:bg-blue-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            Voir
                          </a>
                          <a href="{% url 'custom_requests:download_document' doc.id %}" class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-green-600 bg-green-100 hover:bg-green-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Télécharger
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-6">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun document</h3>
                <p class="mt-1 text-sm text-gray-500">Aucun document n'a été téléchargé pour cette demande.</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Messages -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-content-between items-center">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              Messages
            </h2>
            {% if service_request.status != 'pending' %}
              <a href="{% url 'expert_messages' %}?client={{ service_request.client.id }}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                Ouvrir le chat
              </a>
            {% endif %}
          </div>
          <div class="p-6">
            {% if messages_list %}
              <div class="space-y-4 max-h-80 overflow-y-auto">
                {% for message in messages_list %}
                  <div class="{% if message.sender == request.user %}ml-8{% else %}mr-8{% endif %}">
                    <div class="{% if message.sender == request.user %}bg-blue-100 text-blue-900{% else %}bg-gray-100 text-gray-900{% endif %} rounded-lg p-4">
                      <div class="flex justify-between items-start mb-2">
                        <span class="font-medium text-sm">{{ message.sender.first_name }} {{ message.sender.name }}</span>
                        <span class="text-xs text-gray-500">{{ message.sent_at|date:"d/m/Y H:i" }}</span>
                      </div>
                      <div class="text-sm">{{ message.content }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% elif service_request.status == 'pending' %}
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Accès restreint</h3>
                <p class="mt-1 text-sm text-gray-500">Vous devez prendre en charge cette demande avant de pouvoir démarrer une conversation.</p>
              </div>
            {% else %}
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun message</h3>
                <p class="mt-1 text-sm text-gray-500">Aucun message pour le moment. Démarrez la conversation avec le client.</p>
                <div class="mt-4">
                  <a href="{% url 'messaging:chat' service_request.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    Démarrer la conversation
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Appointments Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">Rendez-vous</h2>
            <button type="button" onclick="openModal('scheduleAppointmentModal')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              Planifier un rendez-vous
            </button>
          </div>
          <div class="p-6">
            {% if appointments %}
              <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                <table class="min-w-full divide-y divide-gray-300">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date et heure</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durée</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    {% for appointment in appointments %}
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ appointment.date_time|date:"d/m/Y H:i" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ appointment.duration }} minutes</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ appointment.get_type_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          {% if appointment.status == 'scheduled' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              {{ appointment.get_status_display }}
                            </span>
                          {% elif appointment.status == 'completed' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              {{ appointment.get_status_display }}
                            </span>
                          {% elif appointment.status == 'cancelled' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              {{ appointment.get_status_display }}
                            </span>
                          {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                          {% if appointment.status == 'scheduled' %}
                            <button class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-green-600 bg-green-100 hover:bg-green-200 complete-appointment" data-id="{{ appointment.id }}">
                              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                              </svg>
                              Terminer
                            </button>
                            <button class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-red-600 bg-red-100 hover:bg-red-200 cancel-appointment" data-id="{{ appointment.id }}">
                              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                              </svg>
                              Annuler
                            </button>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-6">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun rendez-vous</h3>
                <p class="mt-1 text-sm text-gray-500">Aucun rendez-vous n'a été planifié pour cette demande.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Status Update Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Mise à jour du statut</h2>
          </div>
          <div class="p-6">
            <form action="{% url 'expert_update_request_status' service_request.id %}" method="post" class="space-y-4">
              {% csrf_token %}
              <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Nouveau statut:</label>
                <select id="status" name="status" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="" disabled>Sélectionner un statut</option>
                  <option value="in_progress" {% if service_request.status == 'in_progress' %}selected{% endif %}>En cours</option>
                  <option value="pending_info" {% if service_request.status == 'pending_info' %}selected{% endif %}>En attente d'informations</option>
                  <option value="completed" {% if service_request.status == 'completed' %}selected{% endif %}>Terminée</option>
                </select>
              </div>
              <div>
                <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">Commentaire (optionnel):</label>
                <textarea id="comment" name="comment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ajoutez un commentaire..."></textarea>
              </div>
              <button type="submit" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Mettre à jour
              </button>
            </form>
          </div>
        </div>

        <!-- Client Information Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Informations du client</h2>
          </div>
          <div class="p-6">
            <div class="flex items-center mb-4">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold text-sm mr-3">
                {{ service_request.client.first_name|first }}{{ service_request.client.name|first }}
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-900">{{ service_request.client.first_name }} {{ service_request.client.name }}</h3>
                <p class="text-sm text-gray-500">{{ service_request.client.get_account_type_display }}</p>
              </div>
            </div>
            <div class="space-y-3">
              <div>
                <dt class="text-sm font-medium text-gray-500 flex items-center">
                  <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 7.89a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                  Email:
                </dt>
                <dd class="text-sm text-gray-900 ml-6">{{ service_request.client.email }}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500 flex items-center">
                  <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                  </svg>
                  Téléphone:
                </dt>
                <dd class="text-sm text-gray-900 ml-6">{{ client.phone }}</dd>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Document Modal -->
<div id="uploadDocumentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Télécharger un document</h3>
      <form action="{% url 'expert_upload_document' %}" method="post" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="service_request_id" value="{{ service_request.id }}">
        <div>
          <label for="document_name" class="block text-sm font-medium text-gray-700 mb-2">Nom du document</label>
          <input type="text" id="document_name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label for="document_type" class="block text-sm font-medium text-gray-700 mb-2">Type de document</label>
          <select id="document_type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="" disabled selected>Sélectionner un type</option>
            <option value="identity">Pièce d'identité</option>
            <option value="justification">Justificatif</option>
            <option value="report">Rapport</option>
            <option value="certificate">Certificat</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div>
          <label for="document_file" class="block text-sm font-medium text-gray-700 mb-2">Fichier</label>
          <input type="file" id="document_file" name="file" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="flex flex-col gap-2 pt-4">
          <button type="button" onclick="closeModal('uploadDocumentModal')" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
            Annuler
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
            Télécharger
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Schedule Appointment Modal -->
<div id="scheduleAppointmentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Planifier un rendez-vous</h3>
      <form action="{% url 'expert_schedule_appointment' %}" method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="service_request_id" value="{{ service_request.id }}">
        <div>
          <label for="appointment_date" class="block text-sm font-medium text-gray-700 mb-2">Date et heure</label>
          <input type="datetime-local" id="appointment_date" name="date_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label for="appointment_duration" class="block text-sm font-medium text-gray-700 mb-2">Durée (minutes)</label>
          <input type="number" id="appointment_duration" name="duration" value="30" min="15" step="15" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label for="appointment_type" class="block text-sm font-medium text-gray-700 mb-2">Type de rendez-vous</label>
          <select id="appointment_type" name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="" disabled selected>Sélectionner un type</option>
            <option value="in_person">En personne</option>
            <option value="video">Visioconférence</option>
            <option value="phone">Téléphone</option>
          </select>
        </div>
        <div>
          <label for="appointment_notes" class="block text-sm font-medium text-gray-700 mb-2">Notes (optionnel)</label>
          <textarea id="appointment_notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ajoutez des notes..."></textarea>
        </div>
        <div class="flex flex-col gap-2 pt-4">
          <button type="button" onclick="closeModal('scheduleAppointmentModal')" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
            Annuler
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
            Planifier
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function openModal(modalId) {
  document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
  const modals = ['uploadDocumentModal', 'scheduleAppointmentModal'];
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (event.target === modal) {
      closeModal(modalId);
    }
  });
});

document.addEventListener('DOMContentLoaded', function() {
  // Scroll to bottom of messages
  const messagesContainer = document.querySelector('.space-y-4.max-h-80.overflow-y-auto');
  if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  // Handle appointment status updates
  document.querySelectorAll('.complete-appointment').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Êtes-vous sûr de vouloir marquer ce rendez-vous comme terminé?')) {
        // Submit to update endpoint
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "expert_update_appointment" %}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'appointment_id';
        idInput.value = this.dataset.id;
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'completed';
        
        form.appendChild(csrfInput);
        form.appendChild(idInput);
        form.appendChild(statusInput);
        document.body.appendChild(form);
        form.submit();
      }
    });
  });
  
  document.querySelectorAll('.cancel-appointment').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Êtes-vous sûr de vouloir annuler ce rendez-vous?')) {
        // Submit to update endpoint
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "expert_update_appointment" %}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'appointment_id';
        idInput.value = this.dataset.id;
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = 'cancelled';
        
        form.appendChild(csrfInput);
        form.appendChild(idInput);
        form.appendChild(statusInput);
        document.body.appendChild(form);
        form.submit();
      }
    });
  });
});
</script>
{% endblock %}
