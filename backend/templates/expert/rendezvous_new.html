{% extends 'expert/base.html' %}
{% load static %}

{% block title %}Rendez-vous - Expert{% endblock %}
{% block page_title %}Gestion des Rendez-vous{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header with Actions -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
      <div class="flex items-center space-x-4">
        <h2 class="text-xl font-semibold text-gray-900">Mes Rendez-vous</h2>
        <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">
          {{ appointments.count|default:0 }} RDV
        </span>
      </div>
      
      <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
        <!-- Date Filter -->
        <input type="date" id="dateFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        
        <!-- Status Filter -->
        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          <option value="">Tous les statuts</option>
          <option value="scheduled">Programmé</option>
          <option value="completed">Terminé</option>
          <option value="cancelled">Annulé</option>
          <option value="no_show">Absent</option>
        </select>
        
        <!-- Search -->
        <div class="relative">
          <input type="text" id="searchInput" placeholder="Rechercher client..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar View Toggle -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center justify-between">
      <div class="flex space-x-2">
        <button id="listViewBtn" class="px-4 py-2 text-sm font-medium text-primary bg-blue-50 rounded-lg">
          <i class="bi bi-list mr-2"></i>Liste
        </button>
        <button id="calendarViewBtn" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-lg">
          <i class="bi bi-calendar3 mr-2"></i>Calendrier
        </button>
      </div>
      
      <div class="text-sm text-gray-500">
        Aujourd'hui: {{ today|date:"d M Y" }}
      </div>
    </div>
  </div>

  <!-- Appointments List -->
  <div id="appointmentsContainer">
    {% if appointments %}
      <!-- Upcoming Appointments -->
      {% if upcoming_appointments %}
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Rendez-vous à venir</h3>
        </div>
        <div class="divide-y divide-gray-200">
          {% for appointment in upcoming_appointments %}
            <div class="p-6 appointment-card" data-status="{{ appointment.status }}" data-date="{{ appointment.date|date:'Y-m-d' }}" data-client="{{ appointment.client.user.name }} {{ appointment.client.user.first_name }}">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <div class="flex-shrink-0">
                    {% if appointment.client.user.profile_picture %}
                      <img class="h-12 w-12 rounded-full object-cover" src="{{ appointment.client.user.profile_picture.url }}" alt="Client">
                    {% else %}
                      <div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="bi bi-person-fill text-gray-500 text-lg"></i>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                      <h4 class="text-lg font-medium text-gray-900">{{ appointment.client.user.name }} {{ appointment.client.user.first_name }}</h4>
                      <span class="px-2 py-1 text-xs font-medium rounded-full
                        {% if appointment.status == 'scheduled' %}bg-blue-100 text-blue-800
                        {% elif appointment.status == 'completed' %}bg-green-100 text-green-800
                        {% elif appointment.status == 'cancelled' %}bg-red-100 text-red-800
                        {% elif appointment.status == 'no_show' %}bg-gray-100 text-gray-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {% if appointment.status == 'scheduled' %}Programmé
                        {% elif appointment.status == 'completed' %}Terminé
                        {% elif appointment.status == 'cancelled' %}Annulé
                        {% elif appointment.status == 'no_show' %}Absent
                        {% else %}{{ appointment.status|title }}{% endif %}
                      </span>
                    </div>
                    
                    <div class="mt-2 space-y-1">
                      <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <div class="flex items-center space-x-2">
                          <i class="bi bi-calendar3"></i>
                          <span>{{ appointment.date|date:"l d M Y" }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <i class="bi bi-clock"></i>
                          <span>{{ appointment.time|time:"H:i" }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <i class="bi bi-tag"></i>
                          <span>{{ appointment.service_type|title }}</span>
                        </div>
                      </div>
                      
                      {% if appointment.notes %}
                      <p class="text-sm text-gray-500 mt-2">{{ appointment.notes|truncatewords:15 }}</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <div class="flex items-center space-x-2">
                  {% if appointment.status == 'scheduled' %}
                    <button onclick="updateAppointmentStatus('{{ appointment.id }}', 'completed')" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                      <i class="bi bi-check mr-1"></i>
                      Terminer
                    </button>
                    <button onclick="updateAppointmentStatus('{{ appointment.id }}', 'no_show')" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                      <i class="bi bi-x mr-1"></i>
                      Absent
                    </button>
                  {% endif %}
                  
                  <a href="{% url 'expert_appointment_detail' appointment.id %}" class="inline-flex items-center px-3 py-2 border border-primary text-sm leading-4 font-medium rounded-md text-primary bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    <i class="bi bi-eye mr-1"></i>
                    Voir
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Past Appointments -->
      {% if past_appointments %}
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Rendez-vous passés</h3>
        </div>
        <div class="divide-y divide-gray-200">
          {% for appointment in past_appointments %}
            <div class="p-6 appointment-card opacity-75" data-status="{{ appointment.status }}" data-date="{{ appointment.date|date:'Y-m-d' }}" data-client="{{ appointment.client.user.name }} {{ appointment.client.user.first_name }}">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <div class="flex-shrink-0">
                    {% if appointment.client.user.profile_picture %}
                      <img class="h-10 w-10 rounded-full object-cover" src="{{ appointment.client.user.profile_picture.url }}" alt="Client">
                    {% else %}
                      <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="bi bi-person-fill text-gray-500"></i>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                      <h4 class="text-base font-medium text-gray-700">{{ appointment.client.user.name }} {{ appointment.client.user.first_name }}</h4>
                      <span class="px-2 py-1 text-xs font-medium rounded-full
                        {% if appointment.status == 'completed' %}bg-green-100 text-green-800
                        {% elif appointment.status == 'cancelled' %}bg-red-100 text-red-800
                        {% elif appointment.status == 'no_show' %}bg-gray-100 text-gray-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {% if appointment.status == 'completed' %}Terminé
                        {% elif appointment.status == 'cancelled' %}Annulé
                        {% elif appointment.status == 'no_show' %}Absent
                        {% else %}{{ appointment.status|title }}{% endif %}
                      </span>
                    </div>
                    
                    <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                      <span>{{ appointment.date|date:"d M Y" }} à {{ appointment.time|time:"H:i" }}</span>
                      <span>{{ appointment.service_type|title }}</span>
                    </div>
                  </div>
                </div>
                
                <a href="{% url 'expert_appointment_detail' appointment.id %}" class="text-primary hover:text-blue-700 text-sm">
                  <i class="bi bi-eye"></i>
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% else %}
      <!-- Empty State -->
      <div class="bg-white rounded-lg shadow p-12 text-center">
        <i class="bi bi-calendar-x text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun rendez-vous trouvé</h3>
        <p class="text-gray-500">Il n'y a actuellement aucun rendez-vous programmé.</p>
      </div>
    {% endif %}
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-blue-600">{{ today_appointments|default:0 }}</div>
      <div class="text-sm text-gray-600">Aujourd'hui</div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-green-600">{{ week_appointments|default:0 }}</div>
      <div class="text-sm text-gray-600">Cette semaine</div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-purple-600">{{ completed_appointments|default:0 }}</div>
      <div class="text-sm text-gray-600">Terminés</div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-orange-600">{{ missed_appointments|default:0 }}</div>
      <div class="text-sm text-gray-600">Manqués</div>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
      <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Confirmer l'action</h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500" id="modalMessage">
          Êtes-vous sûr de vouloir modifier le statut de ce rendez-vous?
        </p>
      </div>
      <div class="items-center px-4 py-3">
        <button id="confirmButton" class="px-4 py-2 bg-primary text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
          Confirmer
        </button>
        <button onclick="closeStatusModal()" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', function() {
    const dateFilter = document.getElementById('dateFilter');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');
    const appointmentCards = document.querySelectorAll('.appointment-card');

    function filterAppointments() {
      const dateValue = dateFilter.value;
      const statusValue = statusFilter.value.toLowerCase();
      const searchValue = searchInput.value.toLowerCase();

      appointmentCards.forEach(card => {
        const cardDate = card.dataset.date;
        const status = card.dataset.status.toLowerCase();
        const client = card.dataset.client.toLowerCase();
        
        const dateMatch = !dateValue || cardDate === dateValue;
        const statusMatch = !statusValue || status.includes(statusValue);
        const searchMatch = !searchValue || client.includes(searchValue);

        if (dateMatch && statusMatch && searchMatch) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    dateFilter.addEventListener('change', filterAppointments);
    statusFilter.addEventListener('change', filterAppointments);
    searchInput.addEventListener('input', filterAppointments);
  });

  // Status update functionality
  let currentAppointmentId = null;
  let currentStatus = null;

  function updateAppointmentStatus(appointmentId, status) {
    currentAppointmentId = appointmentId;
    currentStatus = status;
    
    const modal = document.getElementById('statusModal');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    
    if (status === 'completed') {
      title.textContent = 'Terminer le rendez-vous';
      message.textContent = 'Êtes-vous sûr de vouloir marquer ce rendez-vous comme terminé?';
    } else if (status === 'no_show') {
      title.textContent = 'Marquer comme absent';
      message.textContent = 'Êtes-vous sûr que le client ne s\'est pas présenté au rendez-vous?';
    } else if (status === 'cancelled') {
      title.textContent = 'Annuler le rendez-vous';
      message.textContent = 'Êtes-vous sûr de vouloir annuler ce rendez-vous?';
    }
    
    modal.classList.remove('hidden');
  }

  function closeStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
    currentAppointmentId = null;
    currentStatus = null;
  }

  document.getElementById('confirmButton').addEventListener('click', function() {
    if (currentAppointmentId && currentStatus) {
      // Send AJAX request to update status
      fetch(`/expert/appointments/${currentAppointmentId}/update-status/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          status: currentStatus
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload(); // Reload to show updated status
        } else {
          alert('Erreur lors de la mise à jour du statut');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Erreur de connexion');
      });
    }
    
    closeStatusModal();
  });

  // Close modal when clicking outside
  document.getElementById('statusModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeStatusModal();
    }
  });

  // View toggle functionality
  document.getElementById('listViewBtn').addEventListener('click', function() {
    this.classList.add('text-primary', 'bg-blue-50');
    this.classList.remove('text-gray-600');
    document.getElementById('calendarViewBtn').classList.add('text-gray-600');
    document.getElementById('calendarViewBtn').classList.remove('text-primary', 'bg-blue-50');
  });

  document.getElementById('calendarViewBtn').addEventListener('click', function() {
    this.classList.add('text-primary', 'bg-blue-50');
    this.classList.remove('text-gray-600');
    document.getElementById('listViewBtn').classList.add('text-gray-600');
    document.getElementById('listViewBtn').classList.remove('text-primary', 'bg-blue-50');
    // TODO: Implement calendar view
    alert('Vue calendrier à venir');
  });
</script>
{% endblock %}
